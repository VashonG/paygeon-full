

  const { existsSync, createReadStream } = require('fs');
  const pageJson = require("./../metadata/pages/pages.json")
  const eventsJson = require("./../metadata/events/events.json")
  const path = require('path')
  undefined
  
  
  const events_findAllEvent = async (req, res) => {
          try {
            res.status(200).send(eventsJson);
          } catch (e) {
            next(e);
          }
        }
        
const events_43f5e0ab858847299227083d96a6a151 = async (req, res) => {
          try {
            const response = eventsJson.find(_doc => _doc.uuid === '43f5e0ab-8588-4729-9227-083d96a6a151')
            res.status(200).send(response);
          } catch (e) {
            next(e);
          }
        }
        
const events_80ae252f052e4053820240de9ecaa200 = async (req, res) => {
          try {
            const response = eventsJson.find(_doc => _doc.uuid === '80ae252f-052e-4053-8202-40de9ecaa200')
            res.status(200).send(response);
          } catch (e) {
            next(e);
          }
        }
        
const events_c7cd950c953b4337990ff374d90a201b = async (req, res) => {
          try {
            const response = eventsJson.find(_doc => _doc.uuid === 'c7cd950c-953b-4337-990f-f374d90a201b')
            res.status(200).send(response);
          } catch (e) {
            next(e);
          }
        }
        
const events_8f4363f626dd41df8f08fd0a7379371b = async (req, res) => {
          try {
            const response = eventsJson.find(_doc => _doc.uuid === '8f4363f6-26dd-41df-8f08-fd0a7379371b')
            res.status(200).send(response);
          } catch (e) {
            next(e);
          }
        }
        
const events_f5f5930288a64c8fa58168099af17486 = async (req, res) => {
          try {
            const response = eventsJson.find(_doc => _doc.uuid === 'f5f59302-88a6-4c8f-a581-68099af17486')
            res.status(200).send(response);
          } catch (e) {
            next(e);
          }
        }
        
const events_5d3bbb35e62f424683d7a09e20f308b1 = async (req, res) => {
          try {
            const response = eventsJson.find(_doc => _doc.uuid === '5d3bbb35-e62f-4246-83d7-a09e20f308b1')
            res.status(200).send(response);
          } catch (e) {
            next(e);
          }
        }
        
const events_691728c3203f4c5c82037167600dddd3 = async (req, res) => {
          try {
            const response = eventsJson.find(_doc => _doc.uuid === '691728c3-203f-4c5c-8203-7167600dddd3')
            res.status(200).send(response);
          } catch (e) {
            next(e);
          }
        }
        
const events_9de771d4dced4912ab26f87b1adfd521 = async (req, res) => {
          try {
            const response = eventsJson.find(_doc => _doc.uuid === '9de771d4-dced-4912-ab26-f87b1adfd521')
            res.status(200).send(response);
          } catch (e) {
            next(e);
          }
        }
        
const events_7ea00ef7fc8041bb89d981bfe19142b6 = async (req, res) => {
          try {
            const response = eventsJson.find(_doc => _doc.uuid === '7ea00ef7-fc80-41bb-89d9-81bfe19142b6')
            res.status(200).send(response);
          } catch (e) {
            next(e);
          }
        }
        
const events_b830cd3e1f37472c989fd3eefcb51b5f = async (req, res) => {
          try {
            const response = eventsJson.find(_doc => _doc.uuid === 'b830cd3e-1f37-472c-989f-d3eefcb51b5f')
            res.status(200).send(response);
          } catch (e) {
            next(e);
          }
        }
        
const events_ac7a0837a1614235bc04aa78dc455b16 = async (req, res) => {
          try {
            const response = eventsJson.find(_doc => _doc.uuid === 'ac7a0837-a161-4235-bc04-aa78dc455b16')
            res.status(200).send(response);
          } catch (e) {
            next(e);
          }
        }
        
const events_7e39b73dab2f445d9cf0fd92ecf391b5 = async (req, res) => {
          try {
            const response = eventsJson.find(_doc => _doc.uuid === '7e39b73d-ab2f-445d-9cf0-fd92ecf391b5')
            res.status(200).send(response);
          } catch (e) {
            next(e);
          }
        }
        
const events_a8420bf65cf940b2b17c6167790b56c7 = async (req, res) => {
          try {
            const response = eventsJson.find(_doc => _doc.uuid === 'a8420bf6-5cf9-40b2-b17c-6167790b56c7')
            res.status(200).send(response);
          } catch (e) {
            next(e);
          }
        }
        
const events_84fbb6a10d874817b7587868c05b8d3b = async (req, res) => {
          try {
            const response = eventsJson.find(_doc => _doc.uuid === '84fbb6a1-0d87-4817-b758-7868c05b8d3b')
            res.status(200).send(response);
          } catch (e) {
            next(e);
          }
        }
        
const events_ed2171f7c28146609c036bbddbf13ba3 = async (req, res) => {
          try {
            const response = eventsJson.find(_doc => _doc.uuid === 'ed2171f7-c281-4660-9c03-6bbddbf13ba3')
            res.status(200).send(response);
          } catch (e) {
            next(e);
          }
        }
        
const events_433732d1248d4d3da901470645472fcd = async (req, res) => {
          try {
            const response = eventsJson.find(_doc => _doc.uuid === '433732d1-248d-4d3d-a901-470645472fcd')
            res.status(200).send(response);
          } catch (e) {
            next(e);
          }
        }
        
const events_a97aa179e34c4c9c9f111ead55d885d0 = async (req, res) => {
          try {
            const response = eventsJson.find(_doc => _doc.uuid === 'a97aa179-e34c-4c9c-9f11-1ead55d885d0')
            res.status(200).send(response);
          } catch (e) {
            next(e);
          }
        }
        
const events_2940f3255b5a43ac9f95bfcc95b69d4f = async (req, res) => {
          try {
            const response = eventsJson.find(_doc => _doc.uuid === '2940f325-5b5a-43ac-9f95-bfcc95b69d4f')
            res.status(200).send(response);
          } catch (e) {
            next(e);
          }
        }
        

const getPageByUrl = async (pageSlug) => {
    return pageJson.find((_doc) => {
      if(pageSlug){
        if(_doc.slug == pageSlug){
          return _doc
        }
      } else {
        if(_doc.isDefaultPage == true){
          return _doc
        }
      }
    })
};

const onlypageId = async (req, res, next) => {
  try {
      const { db, params } = req;
      const fullUrl = req.protocol + '://' + req.get('host') + req.originalUrl;
      console.log(fullUrl);
      let { pageId = req.originalUrl.split("/")[1] } = params;
      if (pageId === 'lib' || pageId === 'js' || pageId === "resources" || pageId === "static") {
        return next();
      }
      let pageResponse = await getPageByUrl(pageId);
      if(!pageResponse){
        return next()
      }
      pageId = pageResponse.slug;
      const pagePath = pageId+"/"+pageId+".hbs";

      // return res.render(pagePath)
      if (!existsSync(path.join(__dirname, "../views/"+pagePath))) {
        return res.send('Please publish the project to view it.');
      }

      reUsable({req: req, res: res, fullUrl: fullUrl, pageId: pageId, pagePath: pagePath, pageResponse: pageResponse})
    } catch (error) {
      console.log('error :>> ', error);
      next(error);
    }
};

const pageWithItemId = async (req, res, next) => {
  try {
      const { db, params } = req;
      const fullUrl = req.protocol + '://' + req.get('host') + req.originalUrl;
      console.log(fullUrl);
      let { pageId = req.originalUrl.split("/")[1], collectionName = req.originalUrl.split("/")[2], itemId = req.originalUrl.split("/")[3] } = params;
      if (pageId === 'lib' || pageId === 'js' || pageId === "resources" || pageId === "static") {
        return next();
      }
      if(pageId == "api" || collectionName == "v1"){
        return next()
      }
      let pageResponse = await getPageByUrl(pageId);
      if(!pageResponse){
        return next()
      }
      pageId = pageResponse.slug;
      const pagePath = pageId+"/"+pageId+".hbs";

      // return res.render(pagePath)
      if (itemId && itemId.includes('_')) {
        itemId = itemId.split('_')[1];
      }
      if (!existsSync(path.join(__dirname, "../views/"+pagePath))) {
        return res.send('Please publish the project to view it.');
      }

      reUsable({req: req, res: res, pageId: pageId, fullUrl:fullUrl, pagePath: pagePath, pageResponse: pageResponse, collectionName: collectionName, itemId: itemId})
    } catch (error) {
      console.log('error :>> ', error);
      next(error);
    }
};

const pageWithPageName = async (req, res, next) => {
  try {
      const { db, params } = req;
      const fullUrl = req.protocol + '://' + req.get('host') + req.originalUrl;
      let { pageId = req.originalUrl.split("/")[2] } = params;
      if (pageId === 'lib' || pageId === 'js' || pageId === "resources" || pageId === "static") {
        return next();
      }
      let pageResponse = await getPageByUrl(pageId);
      if(!pageResponse){
        return next()
      }
      pageId = pageResponse.slug;
      const pagePath = pageId+"/"+pageId+".hbs";

      // return res.render(pagePath)
      if (!existsSync(path.join(__dirname, "../views/"+pagePath))) {
        return res.send('Please publish the project to view it.');
      }

      reUsable({req: req, res: res, fullUrl: fullUrl, pageId: pageId, pagePath: pagePath, pageResponse: pageResponse})
    } catch (error) {
      console.log('error :>> ', error);
      next(error);
    }
};

const allIdsWithPage = async (req, res, next) => {
  try {
      const { db, params } = req;
      const fullUrl = req.protocol + '://' + req.get('host') + req.originalUrl;
      let { pageId = req.originalUrl.split("/")[2], collectionName = req.originalUrl.split("/")[3], itemId = req.originalUrl.split("/")[4] } = params;
      if (pageId === 'lib' || pageId === 'js' || pageId === "resources" || pageId === "static") {
        return next();
      }
      if(pageId == "api" && collectionName == "v1"){
        return next()
      }
      let pageResponse = await getPageByUrl(pageId);
      if(!pageResponse){
        return next()
      }
      pageId = pageResponse.slug;
      const pagePath = pageId+"/"+pageId+".hbs";

      // return res.render(pagePath)
      if (!existsSync(path.join(__dirname, "../views/"+pagePath))) {
        return res.send('Please publish the project to view it.');
      }

      reUsable({req: req, res: res, pageId: pageId, fullUrl:fullUrl, pagePath: pagePath, pageResponse: pageResponse, collectionName: collectionName, itemId: itemId})
    } catch (error) {
      console.log('error :>> ', error);
      next(error);
    }
};

function reUsable({ req, res,  pagePath, fullUrl, pageResponse, collectionName, itemId, pageId }){
  let pageContent = '';
  let readerStream;
  readerStream = createReadStream(path.join(__dirname, "../views/"+pagePath))
  readerStream.setEncoding('UTF8');

  readerStream.on('data', (chunk) => {
    pageContent += chunk.toString();
  });

  readerStream.on('error', (err) => {
    console.log('err.stack :>> ', err.stack);
    return res.write(
      'There is some issue reading your build. Please publish the project to view it.',
    );
  });
  readerStream.on('end', async () => {
    if (itemId && collectionName && pageResponse) {
      let { isDescriptionFromCollection, isTitleFromCollection, isPageImageFromCollection } =
        pageResponse;
      if (
        collectionName &&
        (isDescriptionFromCollection || isTitleFromCollection || isPageImageFromCollection)
      ) {
        pageContent = await getDynamicTitle(req, itemId, pageResponse, pageContent);
      }
    }
    pageContent = addMetaURL(pageContent, pageId, fullUrl);

    return res.send(pageContent);
  });
}

const getDynamicTitle = async (req, itemId, pageResponse, pageContent) => {
  const { builderDB, db, user, projectDescription, projectLogoKeyName } = req;
  let {
    collectionId,
    titleTag,
    description,
    pageImage,
    isTitleFromCollection,
    isPageImageFromCollection,
    isDescriptionFromCollection,
  } = pageResponse;
  let data = await findOneItem(builderDB, db, collectionId, itemId, pageResponse, user);
  if (!data) return pageContent;
  if (data && isTitleFromCollection && data[titleTag]) {
    pageContent = pageContent.replace(
      "<title>"+titleTag+"</title>",
      "<title>"+data[titleTag]+"</title>",
    );
    pageContent = pageContent.replace(
      "<meta name='title' content="+titleTag+">",
      "<meta name='title' content="+data[titleTag]+">",
    );
    pageContent = pageContent.replace(
      "<meta property='og:title' content="+titleTag+">",
      "<meta property='og:title' content="+data[titleTag]+">",
    );
    pageContent = pageContent.replace(
      "<meta property='twitter:title' content="+titleTag+">",
      "<meta property='twitter:title' content="+data[titleTag]+">",
    );
  }

  const pageDescription = description ? description : projectDescription;

  if (data && isDescriptionFromCollection && data[description]) {
    pageContent = pageContent.replace(
      "<meta name='description' content="+data[description]+">",
      "<meta name='description' content="+pageDescription+">",
    );
    pageContent = pageContent.replace(
      "<meta property='og:description' content="+pageDescription+">",
      "<meta property='og:description' content="+data[description]+">",
    );
    pageContent = pageContent.replace(
      "<meta property='twitter:description' content="+pageDescription+">",
      "<meta property='twitter:description' content="+data[description]+">",
    );
  }

  const seoImage = pageImage
    ? process.env.S3_BUCKET_URL+"/"+pageImage
    : 'https://drapcode.com/img/DrapCode-Icon-Dark.png';

  const seoImageToReplace =
    pageImage && data[pageImage].key
      ? process.env.S3_BUCKET_URL+"/"+data[pageImage].key
      : projectLogoKeyName
      ? process.env.S3_BUCKET_URL+"/"+projectLogoKeyName
      : 'https://drapcode.com/img/DrapCode-Icon-Dark.png';

  if (data && isPageImageFromCollection && data[pageImage]) {
    pageContent = pageContent.replace(
      "<meta property='og:image' content="+seoImage+">",
      "<meta property='og:image' content="+seoImageToReplace+">",
    );
    pageContent = pageContent.replace(
      "<meta property='twitter:image' content="+seoImage+">",
      "<meta property='twitter:image' content="+seoImageToReplace+">",
    );
  }

  return pageContent;
};

const addMetaURL = (pageContent, pageId, fullUrl) => {
  if (fullUrl) {
    pageContent = pageContent.replace(
      "<meta property='og:url' content="+pageId+".html"+">",
      "<meta property='og:url' content="+fullUrl+">",
    );
    pageContent = pageContent.replace(
      "<meta property='twitter:url' content="+pageId+"html"+">",
      "<meta property='twitter:url' content="+fullUrl+">",
    );
  }
  return pageContent;
};

    
module.exports = {
  onlypageId,
  pageWithItemId,
  pageWithPageName,
  allIdsWithPage,
  
  events_findAllEvent,
events_43f5e0ab858847299227083d96a6a151,
events_80ae252f052e4053820240de9ecaa200,
events_c7cd950c953b4337990ff374d90a201b,
events_8f4363f626dd41df8f08fd0a7379371b,
events_f5f5930288a64c8fa58168099af17486,
events_5d3bbb35e62f424683d7a09e20f308b1,
events_691728c3203f4c5c82037167600dddd3,
events_9de771d4dced4912ab26f87b1adfd521,
events_7ea00ef7fc8041bb89d981bfe19142b6,
events_b830cd3e1f37472c989fd3eefcb51b5f,
events_ac7a0837a1614235bc04aa78dc455b16,
events_7e39b73dab2f445d9cf0fd92ecf391b5,
events_a8420bf65cf940b2b17c6167790b56c7,
events_84fbb6a10d874817b7587868c05b8d3b,
events_ed2171f7c28146609c036bbddbf13ba3,
events_433732d1248d4d3da901470645472fcd,
events_a97aa179e34c4c9c9f111ead55d885d0,
events_2940f3255b5a43ac9f95bfcc95b69d4f,

}